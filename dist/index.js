(()=>{var e={22:(e,t,a)=>{const s=a(829),n=a(870),{isTokenBlacklisted:o,blacklistToken:r}=a(284),i=a(484),l=a(930),u=process.env.JWT_SECRET_KEY||"secretkey";e.exports=async(e,t,a)=>{const c=e.header("Authorization")?.replace("Bearer ","");if(!c){const e=new n(401,"TOKEN_NOT_FOUND","Akses ditolak","Token tidak ditemukan. Pastikan Anda sudah login dan menyertakan token dalam header request.");return i.info(`| Auth | - Token tidak ditemukan di request, at ${(new Date).toISOString()}`),t.status(401).json(e.toResponse())}if(await o(c)){const e=new n(401,"TOKEN_BLACKLISTED","Akses ditolak","Sesi login Anda telah berakhir. Silakan login kembali.");return t.status(401).json(e.toResponse())}s.verify(c,u,async(s,o)=>{if(s&&"TokenExpiredError"===s.name){const e=new n(401,"TOKEN_EXPIRED","Akses ditolak","Token sudah kedaluwarsa. Silakan login kembali.");return i.info(`| Auth | - Token expired for user with token: ${c}, at ${(new Date).toISOString()}`),t.status(401).json(e.toResponse())}if(s){const e=new n(401,"INVALID_TOKEN","Akses ditolak","Token tidak valid. Silakan login kembali.");return i.info(`| Auth | - Invalid token, at ${(new Date).toISOString()}`),t.status(401).json(e.toResponse())}const u=o.userId;try{const s=await l("users").where({id:u}).first();if(!s||!s.last_login){const e=new n(401,"USER_NOT_FOUND_OR_NOT_LOGGED_IN","Akses ditolak","Pengguna tidak ditemukan atau belum login.");return t.status(401).json(e.toResponse())}const d=new Date(s.last_login),m=new Date;if(Math.floor((m-d)/864e5)>3){await r(c,86400);const e=new n(401,"LOGIN_EXPIRED","Akses ditolak","Anda belum login dalam 3 hari terakhir. Silakan login kembali.");return i.info("| Auth | - Token valid tapi user idle > 3 hari"),t.status(401).json(e.toResponse())}e.userId=u,i.info(`| Auth | - Token valid for userId: ${o.userId}, at ${(new Date).toISOString()}`),a()}catch(e){i.error(`| Auth | - Gagal mengecek last_login: ${e.message}`);const a=new n(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silahkan coba lagi nanti atau hubungi admin.");t.status(500).json(a.toResponse())}})}},82:(e,t,a)=>{const s=a(577);e.exports=s({origin:"*",methods:["GET","POST","PUT","DELETE","PATCH"],allowedHeaders:["Content-Type","Authorization"],credentials:!0})},87:(e,t,a)=>{const s=a(252).Router(),n=a(654),{loginValidator:o}=a(501),r=a(22),i=a(967);s.post("/signin",i,o,n.login),s.get("/signout",i,r,n.logout),e.exports=s},96:e=>{"use strict";e.exports=require("morgan")},97:(e,t,a)=>{const s=a(461),n=a(928),o=a(896),r=n.join(__dirname,"..","public","storage","documents");o.existsSync(r)||(o.mkdirSync(r,{recursive:!0}),console.log(`[MULTER] Folder '${r}' telah dibuat.`));const i=s.diskStorage({destination:(e,t,a)=>{a(null,r)},file_name:(e,t,a)=>{a(null,Math.random().toString(36).substring(2,27))}}),l=s({storage:i});e.exports=l},124:e=>{"use strict";e.exports=require("winston")},252:e=>{"use strict";e.exports=require("express")},284:(e,t,a)=>{const s=a(623);e.exports={blacklistToken:async(e,t)=>{const a=parseInt(t,10);!Number.isInteger(a)||a<=0?(console.warn(`[Redis] Invalid expirationInSeconds (${t}), fallback to 86400`),await s.setEx(`blacklist:${e}`,86400,"true")):await s.setEx(`blacklist:${e}`,a,"true")},isTokenBlacklisted:async e=>"true"===await s.get(`blacklist:${e}`)}},332:e=>{e.exports=class{constructor(e,t=null,a,s,n=null){this.status=e,this.case=t,this.title=a,this.description=s,this.data=n}toResponse(){return{status:this.status,case:this.case,message:{title:this.title,description:this.description},data:this.data}}}},341:(e,t,a)=>{const{deleteDocuments:s,uploadDocuments:n}=a(701),o=a(332),r=a(870),i=a(484);function l(e){if(Array.isArray(e))return e;if("string"==typeof e)try{const t=JSON.parse(e);if(Array.isArray(t))return t}catch(t){const a=e.replace(/[\[\]\s'"]/g,"");return a?a.split(",").map(e=>e.trim()).filter(Boolean):[]}return[]}t.uploadDocuments=async(e,t)=>{try{const a=e.files;if(!a||0===a.length){const e=new r(400,"NO_FILES","Gagal Upload Dokumen","Tidak ada file yang dikirim. Silakan pilih dokumen terlebih dahulu.");return t.status(400).json(e.toResponse())}const s=await n(a),i=new o(201,"UPLOAD_SUCCESS","Upload Berhasil","Dokumen berhasil diunggah ke server.",s);return t.status(201).json(i.toResponse())}catch(e){i.error(`| Upload Documents Server | - Server error: ${e.message}`,{stack:e.stack});const a=new r(500,"SERVER_ERROR","Login Gagal.","Terjadi kesalahan di server. Silakan coba lagi nanti.");t.status(500).json(a.toResponse())}},t.deleteDocuments=async(e,t)=>{try{let a=l(e?.body?.document_ids);if(0===a.length&&(a=l(e?.query?.ids)),0===a.length){const e=new r(400,"INVALID_INPUT","Gagal Menghapus Dokumen","Mohon kirimkan document_ids yang valid.");return t.status(400).json(e.toResponse())}const n=/^[0-9a-f]{8}-[0-9a-f]{4}-4[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i,o=a.filter(e=>!n.test(e));if(o.length){const e=new r(400,"INVALID_INPUT","Gagal Menghapus Dokumen",`Terdapat ID tidak valid: ${o.join(", ")}`);return t.status(400).json(e.toResponse())}const u=await s(a);if(Array.isArray(u)&&u.length>0)for(const e of u)i.info(`| Delete Documents Server | - Dokumen id ${e} berhasil dihapus.`);const c=a.filter(e=>!u.includes(e));if(c.length>0&&i.warn(`| Delete Documents Server | - ID tidak ditemukan/gagal dihapus: ${c.join(", ")}`),!u||0===u.length){const e=new r(404,"NO_DOCUMENT_DELETED","Dokumen Tidak Ditemukan","Tidak ada dokumen yang berhasil dihapus.");return t.status(404).json(e.toResponse())}const d=new r(200,"DELETE_SUCCESS","Dokumen Berhasil Dihapus",`Berhasil menghapus ${u.length} dokumen.`);return t.status(200).json(d.toResponse())}catch(e){i.error(`| Delete Documents Server | - Server error: ${e.message}`,{stack:e.stack});const a=new r(500,"SERVER_ERROR","Gagal Menghapus Dokumen","Terjadi kesalahan di server. Silakan coba lagi nanti.");return t.status(500).json(a.toResponse())}}},461:e=>{"use strict";e.exports=require("multer")},484:(e,t,a)=>{const s=a(124),n=s.createLogger({level:"info",format:s.format.combine(s.format.timestamp(),s.format.json()),transports:[new s.transports.Console({format:s.format.combine(s.format.colorize({all:!0}),s.format.simple())}),new s.transports.File({filename:"logger.log"})]});e.exports=n},501:(e,t,a)=>{const{body:s}=a(975);t.loginValidator=[s("email").notEmpty().withMessage("Email tidak boleh kosong.").bail().isEmail().withMessage("Silahkan masukkan email yang valid, bisa berupa @gmail atau yang lain."),s("password").notEmpty().withMessage("Password tidak boleh kosong.").bail().isLength({min:8}).withMessage("Password minimal terdiri dari 8 karakter.")]},577:e=>{"use strict";e.exports=require("cors")},623:(e,t,a)=>{const s=a(835).createClient({socket:{host:"localhost",port:6379}});(async()=>{try{await s.connect(),console.log("✅ Redis client connected successfully.")}catch(e){console.error("❌ Redis connection error:",e)}})(),s.on("error",e=>{console.error("Redis Error:",e)}),e.exports=s},636:(e,t,a)=>{const s=a(252).Router(),n=a(341),o=a(97),r=a(22),i=a(967);s.post("/upload-file",i,r,o.array("files",20),n.uploadDocuments),s.delete("/delete-file",i,r,n.deleteDocuments),e.exports=s},654:(e,t,a)=>{const s=a(729),n=a(829),{blacklistToken:o}=a(284),{validationResult:r}=a(975),i=a(484),l=a(930),u=a(332),c=a(870),d=process.env.JWT_SECRET_KEY||"secretkey";t.login=async(e,t)=>{if(!r(e).isEmpty()){const e=new c(400,"VALIDATION_FAILED","Login Gagal.","Tolong periksa kembali input anda. Pastikan email dan password terisi dengan benar.");return t.status(400).json(e.toResponse())}const{email:a,password:o}=e.body;try{const e=await l("users").where({email:a}).first();if(!e){i.info(`| Login | - Invalid credentials for email: ${a}, at ${(new Date).toISOString()}`);const e=new c(400,"INVALID_CREDENTIALS","Login Gagal.","Password atau email yang anda masukkan tidak valid, silahkan periksa kembali dan pastikan akun anda sudah terdaftar.");return t.status(400).json(e.toResponse())}if(!await s.compare(o,e.password)){i.info(`| Login | - Invalid credentials for email: ${a}, at ${(new Date).toISOString()}`);const e=new c(400,"INVALID_CREDENTIALS","Login Gagal.","Password atau email yang anda masukkan tidak valid, silahkan periksa kembali dan pastikan akun anda sudah terdaftar.");return t.status(400).json(e.toResponse())}await l("users").where({id:e.id}).update({last_login:l.fn.now()});const r={userId:e.id},m=n.sign(r,d);i.info(`| Login | - Login success for email: ${a}, at ${(new Date).toISOString()}`);const p={id:e.id,name:e.name,email:e.email,username:e.username,last_login:e.last_login},g=new u(200,"LOGIN_SUCCESS","Login Berhasil.","Selamat datang, anda berhasil login di server Rimba Dokumen.",{token:m,user:p});t.status(200).json(g.toResponse())}catch(e){i.error(`| Auth | - Error function login: ${e.message}`);const a=new c(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silahkan coba lagi nanti atau hubungi admin.");t.status(500).json(a.toResponse())}},t.logout=async(e,t)=>{const a=e.userId,s=e.header("Authorization")?.replace("Bearer ","");try{if(!a){const e=new c(401,"NO_ACTIVE_SESSION","Logout Gagal","Anda tidak memiliki sesi login yang aktif.");return i.info(`| Logout | - No active session for userId: ${a}`),t.status(401).json(e.toResponse())}const e=n.decode(s).exp-Math.floor(Date.now()/1e3);await o(s,e),i.info(`| Logout | - Logout success for userId: ${a}, at ${(new Date).toISOString()}`);const r=new c(200,"LOGOUT_SUCCESS","Logout Berhasil","Anda berhasil melakukan logout.");t.status(200).json(r.toResponse())}catch(e){i.error(`| Auth | - Error function logout: ${e.message}`);const a=new c(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silahkan coba lagi nanti atau hubungi admin.");t.status(500).json(a.toResponse())}}},701:(e,t,a)=>{const s=a(896),n=a(928),o=a(930),r=a(484);function i(e=4001){return"linux"===String(process.env.PG_ENV||"windows").trim().toLowerCase()?"https://doc.rimbaexium.org":`http://localhost:${e}`}function l(e){if(0===e)return 0;const t=parseInt(Math.floor(Math.log(e)/Math.log(1024)));return`${(e/Math.pow(1024,t)).toFixed(2)} ${["b","kB","mB","gB","tB"][t]}`}e.exports={uploadDocuments:async function(e){const t=[],a=n.join(__dirname,"..","public","storage","documents");try{s.existsSync(a)||(s.mkdirSync(a,{recursive:!0}),r.info(`| Upload Documents Server Helper | - Folder dibuat: ${a}`))}catch(e){throw r.error(`| Upload Documents Server Helper | - Gagal membuat folder: ${e.message}`),new Error("Gagal menyiapkan direktori penyimpanan dokumen.")}for(const u of e)try{const e=n.extname(u.originalname);let c=n.join(a,u.originalname),d=1;for(;s.existsSync(c);){const t=n.basename(u.originalname,e);c=n.join(a,`${t}(${d})${e}`),d++}s.renameSync(u.path,c);const m=i(3001),p=`storage/documents/${n.basename(c)}`,g=`${m}/${p}`,k=u.mimetype,h=u.size,f=l(h),w=(await o("documents").insert({file_name:n.basename(c),file_path:p,file_url:g,file_mime_type:k,file_size:h}).returning(["id","created_at","updated_at"]))[0];t.push({server_file_id:w.id,server_file_name:n.basename(c),server_file_path:p,server_file_url:g,server_file_mime_type:k,server_file_size:f}),r.info(`| Upload Documents Server Helper | - Success: ${n.basename(c)} (${f})`)}catch(e){r.error(`| Upload Documents Server Helper | - Failed on file ${u.originalname}: ${e.message}`)}return t},deleteDocuments:async function(e=[]){const t=[];for(const a of e)try{const e=await o("documents").select("file_path").where({id:a}).first();if(!e){r.warn(`| Delete Documents Server Helper | - Dokumen ID ${a} tidak ditemukan.`);continue}const i=n.join(__dirname,"..","public",e.file_path);s.existsSync(i)?s.unlinkSync(i):r.warn(`| Delete Documents Server Helper | - File tidak ditemukan di path: ${i}`),await o("documents").where({id:a}).del(),t.push(a),r.info(`| Delete Documents Server Helper | - Dokumen ${a} berhasil dihapus.`)}catch(e){r.error(`| Delete Documents Server Helper | - Gagal menghapus dokumen ${a}: ${e.message}`)}return t}}},729:e=>{"use strict";e.exports=require("bcryptjs")},763:e=>{"use strict";e.exports=require("express-rate-limit")},818:e=>{"use strict";e.exports=require("dotenv")},829:e=>{"use strict";e.exports=require("jsonwebtoken")},832:e=>{"use strict";e.exports=require("knex")},835:e=>{"use strict";e.exports=require("redis")},870:e=>{e.exports=class{constructor(e,t=null,a,s){this.status=e,this.case=t,this.title=a,this.description=s}toResponse(){return{status:this.status,case:this.case,message:{title:this.title,description:this.description}}}}},896:e=>{"use strict";e.exports=require("fs")},928:e=>{"use strict";e.exports=require("path")},930:(e,t,a)=>{const s={windows:{host:"localhost",port:5433,user:"postgres",password:"super.admin",database:"rimba_dokumen"},linux:{host:"localhost",port:5432,user:"user_rimba",password:"password_kuat",database:"doc_rimba"}},n=a(832)({client:"pg",connection:s[(process.env.PG_ENV||"windows").toLowerCase()]||s.windows,pool:{min:2,max:50},acquireConnectionTimeout:1e4});e.exports=n},967:(e,t,a)=>{const{rateLimit:s,ipKeyGenerator:n}=a(763),o=a(870),r=a(484),i=s({windowMs:6e4,max:20,keyGenerator:n,standardHeaders:!0,legacyHeaders:!1,message:()=>new o(429,"TOO_MANY_REQUESTS","Terlalu Banyak Permintaan","Anda terlalu banyak melakukan permintaan, coba lagi setelah beberapa saat.").toResponse(),handler:(e,t)=>{const a=new o(429,"TOO_MANY_REQUESTS","Terlalu Banyak Permintaan","Anda terlalu banyak melakukan permintaan, coba lagi setelah beberapa saat.");r.warn(`| RateLimiter | Too many requests from IP: ${e.ip}`),t.status(429).json(a.toResponse())}});e.exports=i},975:e=>{"use strict";e.exports=require("express-validator")}},t={};function a(s){var n=t[s];if(void 0!==n)return n.exports;var o=t[s]={exports:{}};return e[s](o,o.exports,a),o.exports}a(818).config();const s=a(252),n=a(96),o=a(87),r=a(484),i=a(928),l=a(636),u=a(82),c=s();function d(){return"linux"===String(process.env.PG_ENV||"windows").trim().toLowerCase()}d()&&c.set("trust proxy",1);c.locals.baseUrl=(d(),"http://localhost:4003"),c.use(u),c.use(s.json()),c.use(n("dev")),c.get("/",(e,t)=>{t.json({message:"Welcome to the Rimba Document!"})}),c.get("/check-db",async(e,t)=>{try{const e=process.env.PG_ENV||"windows",s=a(930),n=await s.raw("SELECT NOW()");t.json({status:"success",message:`Koneksi database (${e}) berhasil.`,server_time:n.rows[0].now})}catch(e){r.error("DB Connection Error:",e.message),t.status(500).json({status:"error",message:"Gagal terhubung ke database. Pastikan environment sudah benar dan database sudah dijalankan.",error:e.message})}}),c.use("/api/rimba/docs",o),c.use("/storage",s.static(i.join(__dirname,"public","storage"))),c.use("/api/rimba/docs",l),c.listen(4003,()=>{console.log(`Server berjalan di ${c.locals.baseUrl} (listen port 4003)`)})})();