(()=>{var e={22:(e,t,s)=>{const a=s(829),n=s(870),{isTokenBlacklisted:o,blacklistToken:r}=s(284),i=s(484),l=s(930),u=process.env.JWT_SECRET_KEY||"secretkey";e.exports=async(e,t,s)=>{const c=e.header("Authorization")?.replace("Bearer ","");if(!c){const e=new n(401,"TOKEN_NOT_FOUND","Akses ditolak","Token tidak ditemukan. Pastikan Anda sudah login dan menyertakan token dalam header request.");return i.info(`| Auth | - Token tidak ditemukan di request, at ${(new Date).toISOString()}`),t.status(401).json(e.toResponse())}if(await o(c)){const e=new n(401,"TOKEN_BLACKLISTED","Akses ditolak","Sesi login Anda telah berakhir. Silakan login kembali.");return t.status(401).json(e.toResponse())}a.verify(c,u,async(a,o)=>{if(a&&"TokenExpiredError"===a.name){const e=new n(401,"TOKEN_EXPIRED","Akses ditolak","Token sudah kedaluwarsa. Silakan login kembali.");return i.info(`| Auth | - Token expired for user with token: ${c}, at ${(new Date).toISOString()}`),t.status(401).json(e.toResponse())}if(a){const e=new n(401,"INVALID_TOKEN","Akses ditolak","Token tidak valid. Silakan login kembali.");return i.info(`| Auth | - Invalid token, at ${(new Date).toISOString()}`),t.status(401).json(e.toResponse())}const u=o.userId;try{const a=await l("users").where({id:u}).first();if(!a||!a.last_login){const e=new n(401,"USER_NOT_FOUND_OR_NOT_LOGGED_IN","Akses ditolak","Pengguna tidak ditemukan atau belum login.");return t.status(401).json(e.toResponse())}const d=new Date(a.last_login),m=new Date;if(Math.floor((m-d)/864e5)>3){await r(c,86400);const e=new n(401,"LOGIN_EXPIRED","Akses ditolak","Anda belum login dalam 3 hari terakhir. Silakan login kembali.");return i.info("| Auth | - Token valid tapi user idle > 3 hari"),t.status(401).json(e.toResponse())}e.userId=u,i.info(`| Auth | - Token valid for userId: ${o.userId}, at ${(new Date).toISOString()}`),s()}catch(e){i.error(`| Auth | - Gagal mengecek last_login: ${e.message}`);const s=new n(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silahkan coba lagi nanti atau hubungi admin.");t.status(500).json(s.toResponse())}})}},82:(e,t,s)=>{const a=s(577);e.exports=a({origin:"*",methods:["GET","POST","PUT","DELETE","PATCH"],allowedHeaders:["Content-Type","Authorization"],credentials:!0})},87:(e,t,s)=>{const a=s(252).Router(),n=s(654),{loginValidator:o}=s(501),r=s(22),i=s(967);a.post("/signin",i,o,n.login),a.get("/signout",i,r,n.logout),e.exports=a},96:e=>{"use strict";e.exports=require("morgan")},97:(e,t,s)=>{const a=s(461),n=s(928),o=s(896),r=n.join(__dirname,"..","public","storage","documents");o.existsSync(r)||(o.mkdirSync(r,{recursive:!0}),console.log(`[MULTER] Folder '${r}' telah dibuat.`));const i=a.diskStorage({destination:(e,t,s)=>{s(null,r)},file_name:(e,t,s)=>{s(null,Math.random().toString(36).substring(2,27))}}),l=a({storage:i});e.exports=l},124:e=>{"use strict";e.exports=require("winston")},252:e=>{"use strict";e.exports=require("express")},284:(e,t,s)=>{const a=s(623);e.exports={blacklistToken:async(e,t)=>{const s=parseInt(t,10);!Number.isInteger(s)||s<=0?(console.warn(`[Redis] Invalid expirationInSeconds (${t}), fallback to 86400`),await a.setEx(`blacklist:${e}`,86400,"true")):await a.setEx(`blacklist:${e}`,s,"true")},isTokenBlacklisted:async e=>"true"===await a.get(`blacklist:${e}`)}},332:e=>{e.exports=class{constructor(e,t=null,s,a,n=null){this.status=e,this.case=t,this.title=s,this.description=a,this.data=n}toResponse(){return{status:this.status,case:this.case,message:{title:this.title,description:this.description},data:this.data}}}},341:(e,t,s)=>{const{deleteDocuments:a,uploadDocuments:n}=s(701),o=s(332),r=s(870),i=s(484);function l(e){if(Array.isArray(e))return e;if("string"==typeof e)try{const t=JSON.parse(e);if(Array.isArray(t))return t}catch(t){const s=e.replace(/[\[\]\s'"]/g,"");return s?s.split(",").map(e=>e.trim()).filter(Boolean):[]}return[]}t.uploadDocuments=async(e,t)=>{try{const s=e.files;if(!s||0===s.length){const e=new r(400,"NO_FILES","Gagal Upload Dokumen","Tidak ada file yang dikirim. Silakan pilih dokumen terlebih dahulu.");return t.status(400).json(e.toResponse())}const a=await n(s),i=new o(201,"UPLOAD_SUCCESS","Upload Berhasil","Dokumen berhasil diunggah ke server.",a);return t.status(201).json(i.toResponse())}catch(e){i.error(`| Upload Documents Server | - Server error: ${e.message}`,{stack:e.stack});const s=new r(500,"SERVER_ERROR","Login Gagal.","Terjadi kesalahan di server. Silakan coba lagi nanti.");t.status(500).json(s.toResponse())}},t.deleteDocuments=async(e,t)=>{try{let s=l(e?.body?.document_ids);if(0===s.length&&(s=l(e?.query?.ids)),0===s.length){const e=new r(400,"INVALID_INPUT","Gagal Menghapus Dokumen","Mohon kirimkan document_ids yang valid.");return t.status(400).json(e.toResponse())}const n=/^[0-9a-f]{8}-[0-9a-f]{4}-4[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i,o=s.filter(e=>!n.test(e));if(o.length){const e=new r(400,"INVALID_INPUT","Gagal Menghapus Dokumen",`Terdapat ID tidak valid: ${o.join(", ")}`);return t.status(400).json(e.toResponse())}const u=await a(s);if(Array.isArray(u)&&u.length>0)for(const e of u)i.info(`| Delete Documents Server | - Dokumen id ${e} berhasil dihapus.`);const c=s.filter(e=>!u.includes(e));if(c.length>0&&i.warn(`| Delete Documents Server | - ID tidak ditemukan/gagal dihapus: ${c.join(", ")}`),!u||0===u.length){const e=new r(404,"NO_DOCUMENT_DELETED","Dokumen Tidak Ditemukan","Tidak ada dokumen yang berhasil dihapus.");return t.status(404).json(e.toResponse())}const d=new r(200,"DELETE_SUCCESS","Dokumen Berhasil Dihapus",`Berhasil menghapus ${u.length} dokumen.`);return t.status(200).json(d.toResponse())}catch(e){i.error(`| Delete Documents Server | - Server error: ${e.message}`,{stack:e.stack});const s=new r(500,"SERVER_ERROR","Gagal Menghapus Dokumen","Terjadi kesalahan di server. Silakan coba lagi nanti.");return t.status(500).json(s.toResponse())}}},461:e=>{"use strict";e.exports=require("multer")},484:(e,t,s)=>{const a=s(124),n=a.createLogger({level:"info",format:a.format.combine(a.format.timestamp(),a.format.json()),transports:[new a.transports.Console({format:a.format.combine(a.format.colorize({all:!0}),a.format.simple())}),new a.transports.File({filename:"logger.log"})]});e.exports=n},501:(e,t,s)=>{const{body:a}=s(975);t.loginValidator=[a("email").notEmpty().withMessage("Email tidak boleh kosong.").bail().isEmail().withMessage("Silahkan masukkan email yang valid, bisa berupa @gmail atau yang lain."),a("password").notEmpty().withMessage("Password tidak boleh kosong.").bail().isLength({min:8}).withMessage("Password minimal terdiri dari 8 karakter.")]},577:e=>{"use strict";e.exports=require("cors")},623:(e,t,s)=>{const a=s(835).createClient({socket:{host:"localhost",port:6379}});(async()=>{try{await a.connect(),console.log("✅ Redis client connected successfully.")}catch(e){console.error("❌ Redis connection error:",e)}})(),a.on("error",e=>{console.error("Redis Error:",e)}),e.exports=a},636:(e,t,s)=>{const a=s(252).Router(),n=s(341),o=s(97),r=s(22),i=s(967);a.post("/upload-file",i,r,o.array("files",20),n.uploadDocuments),a.delete("/delete-file",i,r,n.deleteDocuments),e.exports=a},654:(e,t,s)=>{const a=s(729),n=s(829),{blacklistToken:o}=s(284),{validationResult:r}=s(975),i=s(484),l=s(930),u=s(332),c=s(870),d=process.env.JWT_SECRET_KEY||"secretkey";t.login=async(e,t)=>{if(!r(e).isEmpty()){const e=new c(400,"VALIDATION_FAILED","Login Gagal.","Tolong periksa kembali input anda. Pastikan email dan password terisi dengan benar.");return t.status(400).json(e.toResponse())}const{email:s,password:o}=e.body;try{const e=await l("users").where({email:s}).first();if(!e){i.info(`| Login | - Invalid credentials for email: ${s}, at ${(new Date).toISOString()}`);const e=new c(400,"INVALID_CREDENTIALS","Login Gagal.","Password atau email yang anda masukkan tidak valid, silahkan periksa kembali dan pastikan akun anda sudah terdaftar.");return t.status(400).json(e.toResponse())}if(!await a.compare(o,e.password)){i.info(`| Login | - Invalid credentials for email: ${s}, at ${(new Date).toISOString()}`);const e=new c(400,"INVALID_CREDENTIALS","Login Gagal.","Password atau email yang anda masukkan tidak valid, silahkan periksa kembali dan pastikan akun anda sudah terdaftar.");return t.status(400).json(e.toResponse())}await l("users").where({id:e.id}).update({last_login:l.fn.now()});const r={userId:e.id},m=n.sign(r,d);i.info(`| Login | - Login success for email: ${s}, at ${(new Date).toISOString()}`);const p={id:e.id,name:e.name,email:e.email,username:e.username,last_login:e.last_login},g=new u(200,"LOGIN_SUCCESS","Login Berhasil.","Selamat datang, anda berhasil login di server Rimba Dokumen.",{token:m,user:p});t.status(200).json(g.toResponse())}catch(e){i.error(`| Auth | - Error function login: ${e.message}`);const s=new c(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silahkan coba lagi nanti atau hubungi admin.");t.status(500).json(s.toResponse())}},t.logout=async(e,t)=>{const s=e.userId,a=e.header("Authorization")?.replace("Bearer ","");try{if(!s){const e=new c(401,"NO_ACTIVE_SESSION","Logout Gagal","Anda tidak memiliki sesi login yang aktif.");return i.info(`| Logout | - No active session for userId: ${s}`),t.status(401).json(e.toResponse())}const e=n.decode(a).exp-Math.floor(Date.now()/1e3);await o(a,e),i.info(`| Logout | - Logout success for userId: ${s}, at ${(new Date).toISOString()}`);const r=new c(200,"LOGOUT_SUCCESS","Logout Berhasil","Anda berhasil melakukan logout.");t.status(200).json(r.toResponse())}catch(e){i.error(`| Auth | - Error function logout: ${e.message}`);const s=new c(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silahkan coba lagi nanti atau hubungi admin.");t.status(500).json(s.toResponse())}}},701:(e,t,s)=>{const a=s(896),n=s(928),o=s(930),r=s(484);function i(e=4001){return"linux"===String(process.env.PG_ENV||"windows").trim().toLowerCase()?"https://doc.rimbaexium.org":`http://localhost:${e}`}function l(e){if(0===e)return 0;const t=parseInt(Math.floor(Math.log(e)/Math.log(1024)));return`${(e/Math.pow(1024,t)).toFixed(2)} ${["b","kB","mB","gB","tB"][t]}`}e.exports={uploadDocuments:async function(e){const t=[],s=n.join(__dirname,"..","public","storage","documents");try{a.existsSync(s)||(a.mkdirSync(s,{recursive:!0}),r.info(`| Upload Documents Server Helper | - Folder dibuat: ${s}`))}catch(e){throw r.error(`| Upload Documents Server Helper | - Gagal membuat folder: ${e.message}`),new Error("Gagal menyiapkan direktori penyimpanan dokumen.")}for(const u of e)try{const e=n.extname(u.originalname);let c=n.join(s,u.originalname),d=1;for(;a.existsSync(c);){const t=n.basename(u.originalname,e);c=n.join(s,`${t}(${d})${e}`),d++}a.renameSync(u.path,c);const m=i(3001),p=`storage/documents/${n.basename(c)}`,g=`${m}/${p}`,k=u.mimetype,h=u.size,f=l(h),w=(await o("documents").insert({file_name:n.basename(c),file_path:p,file_url:g,file_mime_type:k,file_size:h}).returning(["id","created_at","updated_at"]))[0];t.push({server_file_id:w.id,server_file_name:n.basename(c),server_file_path:p,server_file_url:g,server_file_mime_type:k,server_file_size:f}),r.info(`| Upload Documents Server Helper | - Success: ${n.basename(c)} (${f})`)}catch(e){r.error(`| Upload Documents Server Helper | - Failed on file ${u.originalname}: ${e.message}`)}return t},deleteDocuments:async function(e=[]){const t=[];for(const s of e)try{const e=await o("documents").select("file_path").where({id:s}).first();if(!e){r.warn(`| Delete Documents Server Helper | - Dokumen ID ${s} tidak ditemukan.`);continue}const i=n.join(__dirname,"..","public",e.file_path);a.existsSync(i)?a.unlinkSync(i):r.warn(`| Delete Documents Server Helper | - File tidak ditemukan di path: ${i}`),await o("documents").where({id:s}).del(),t.push(s),r.info(`| Delete Documents Server Helper | - Dokumen ${s} berhasil dihapus.`)}catch(e){r.error(`| Delete Documents Server Helper | - Gagal menghapus dokumen ${s}: ${e.message}`)}return t}}},729:e=>{"use strict";e.exports=require("bcryptjs")},763:e=>{"use strict";e.exports=require("express-rate-limit")},818:e=>{"use strict";e.exports=require("dotenv")},829:e=>{"use strict";e.exports=require("jsonwebtoken")},832:e=>{"use strict";e.exports=require("knex")},835:e=>{"use strict";e.exports=require("redis")},870:e=>{e.exports=class{constructor(e,t=null,s,a){this.status=e,this.case=t,this.title=s,this.description=a}toResponse(){return{status:this.status,case:this.case,message:{title:this.title,description:this.description}}}}},896:e=>{"use strict";e.exports=require("fs")},928:e=>{"use strict";e.exports=require("path")},930:(e,t,s)=>{const a={windows:{host:"localhost",port:5433,user:"postgres",password:"super.admin",database:"rimba_dokumen"},linux:{host:"localhost",port:5432,user:"user_rimba",password:"password_kuat",database:"doc_rimba"}},n=s(832)({client:"pg",connection:a[(process.env.PG_ENV||"windows").toLowerCase()]||a.windows,pool:{min:2,max:50},acquireConnectionTimeout:1e4});e.exports=n},967:(e,t,s)=>{const{rateLimit:a,ipKeyGenerator:n}=s(763),o=s(870),r=s(484),i=a({windowMs:6e4,max:20,keyGenerator:n,standardHeaders:!0,legacyHeaders:!1,message:()=>new o(429,"TOO_MANY_REQUESTS","Terlalu Banyak Permintaan","Anda terlalu banyak melakukan permintaan, coba lagi setelah beberapa saat.").toResponse(),handler:(e,t)=>{const s=new o(429,"TOO_MANY_REQUESTS","Terlalu Banyak Permintaan","Anda terlalu banyak melakukan permintaan, coba lagi setelah beberapa saat.");r.warn(`| RateLimiter | Too many requests from IP: ${e.ip}`),t.status(429).json(s.toResponse())}});e.exports=i},975:e=>{"use strict";e.exports=require("express-validator")}},t={};function s(a){var n=t[a];if(void 0!==n)return n.exports;var o=t[a]={exports:{}};return e[a](o,o.exports,s),o.exports}s(818).config();const a=s(252),n=s(96),o=s(87),r=s(484),i=s(928),l=s(636),u=s(82),c=a();function d(){return"linux"===String(process.env.PG_ENV||"windows").trim().toLowerCase()}d()&&c.set("trust proxy",1);c.locals.baseUrl=d()?"https://rimba.webgis.app/cms":"http://localhost:4003",c.use(u),c.use(a.json()),c.use(n("dev")),c.get("/cms",(e,t)=>{t.json({message:"Welcome to the Rimba Document!"})}),c.get("/cms/check-db",async(e,t)=>{try{const e=process.env.PG_ENV||"windows",a=s(930),n=await a.raw("SELECT NOW()");t.json({status:"success",message:`Koneksi database (${e}) berhasil.`,server_time:n.rows[0].now})}catch(e){r.error("DB Connection Error:",e.message),t.status(500).json({status:"error",message:"Gagal terhubung ke database. Pastikan environment sudah benar dan database sudah dijalankan.",error:e.message})}});const m=i.join(__dirname,"../public/storage");c.use("/cms/api/rimba/docs",o),c.use("/cms/storage",a.static(m)),c.use("/cms/api/rimba/docs",l),c.listen(4003,()=>{console.log(`Server berjalan di ${c.locals.baseUrl} (listen port 4003)`)})})();