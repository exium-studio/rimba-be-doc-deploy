(()=>{var e={16:e=>{"use strict";e.exports=require("url")},22:(e,t,s)=>{const a=s(829),n=s(870),{isTokenBlacklisted:r,blacklistToken:o}=s(284),i=s(484),l=s(930),u=process.env.JWT_SECRET_KEY;e.exports=async(e,t,s)=>{const c=e.header("Authorization")?.replace("Bearer ","");if(!c){const e=new n(401,"TOKEN_NOT_FOUND","Akses ditolak","Token tidak ditemukan. Pastikan Anda sudah login dan menyertakan token dalam header request.");return i.info(`| Auth | - Token tidak ditemukan di request, at ${(new Date).toISOString()}`),t.status(401).json(e.toResponse())}if(await r(c)){const e=new n(401,"TOKEN_BLACKLISTED","Akses ditolak","Sesi login Anda telah berakhir. Silakan login kembali.");return t.status(401).json(e.toResponse())}a.verify(c,u,async(a,r)=>{if(a&&"TokenExpiredError"===a.name){const e=new n(401,"TOKEN_EXPIRED","Akses ditolak","Token sudah kedaluwarsa. Silakan login kembali.");return i.info(`| Auth | - Token expired for user with token: ${c}, at ${(new Date).toISOString()}`),t.status(401).json(e.toResponse())}if(a){const e=new n(401,"INVALID_TOKEN","Akses ditolak","Token tidak valid. Silakan login kembali.");return i.info(`| Auth | - Invalid token, at ${(new Date).toISOString()}`),t.status(401).json(e.toResponse())}const u=r.userId;try{const a=await l("users").where({id:u}).first();if(!a||!a.last_login){const e=new n(401,"USER_NOT_FOUND_OR_NOT_LOGGED_IN","Akses ditolak","Pengguna tidak ditemukan atau belum login.");return t.status(401).json(e.toResponse())}const d=new Date(a.last_login),m=new Date;if(Math.floor((m-d)/864e5)>3){await o(c,86400);const e=new n(401,"LOGIN_EXPIRED","Akses ditolak","Anda belum login dalam 3 hari terakhir. Silakan login kembali.");return i.info("| Auth | - Token valid tapi user idle > 3 hari"),t.status(401).json(e.toResponse())}e.userId=u,i.info(`| Auth | - Token valid for userId: ${r.userId}, at ${(new Date).toISOString()}`),s()}catch(e){i.error(`| Auth | - Gagal mengecek last_login: ${e.message}`);const s=new n(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silahkan coba lagi nanti atau hubungi admin.");t.status(500).json(s.toResponse())}})}},82:(e,t,s)=>{const a=s(577);e.exports=a({origin:"https://rimba.webgis.app/api",methods:["GET","POST","PUT","DELETE","PATCH"],allowedHeaders:["Content-Type","Authorization"],credentials:!0})},87:(e,t,s)=>{const a=s(252).Router(),n=s(654),{loginValidator:r}=s(501),o=s(22),i=s(967);a.post("/signin",i,r,n.login),a.get("/signout",i,o,n.logout),e.exports=a},96:e=>{"use strict";e.exports=require("morgan")},97:(e,t,s)=>{const a=s(461),n=s(928),r=s(896),o=n.join(__dirname,"..","public","storage","documents");r.existsSync(o)||(r.mkdirSync(o,{recursive:!0}),console.log(`[MULTER] Folder '${o}' telah dibuat.`));const i=a.diskStorage({destination:(e,t,s)=>{s(null,o)},file_name:(e,t,s)=>{s(null,Math.random().toString(36).substring(2,27))}}),l=a({storage:i});e.exports=l},124:e=>{"use strict";e.exports=require("winston")},252:e=>{"use strict";e.exports=require("express")},284:(e,t,s)=>{const a=s(623);e.exports={blacklistToken:async(e,t)=>{const s=parseInt(t,10);!Number.isInteger(s)||s<=0?(console.warn(`[Redis] Invalid expirationInSeconds (${t}), fallback to 86400`),await a.setEx(`blacklist:${e}`,86400,"true")):await a.setEx(`blacklist:${e}`,s,"true")},isTokenBlacklisted:async e=>"true"===await a.get(`blacklist:${e}`)}},332:e=>{e.exports=class{constructor(e,t=null,s,a,n=null){this.status=e,this.case=t,this.title=s,this.description=a,this.data=n}toResponse(){return{status:this.status,case:this.case,message:{title:this.title,description:this.description},data:this.data}}}},341:(e,t,s)=>{const{deleteDocuments:a,uploadDocuments:n}=s(701),r=s(332),o=s(870),i=s(484);function l(e){if(Array.isArray(e))return e;if("string"==typeof e)try{const t=JSON.parse(e);if(Array.isArray(t))return t}catch(t){const s=e.replace(/[\[\]\s'"]/g,"");return s?s.split(",").map(e=>e.trim()).filter(Boolean):[]}return[]}t.uploadDocuments=async(e,t)=>{try{const s=e.files;if(!s||0===s.length){const e=new o(400,"NO_FILES","Gagal Upload Dokumen","Tidak ada file yang dikirim. Silakan pilih dokumen terlebih dahulu.");return t.status(400).json(e.toResponse())}const a=await n(s),i=new r(201,"UPLOAD_SUCCESS","Upload Berhasil","Dokumen berhasil diunggah ke server.",a);return t.status(201).json(i.toResponse())}catch(e){i.error(`| Upload Documents Server | - Server error: ${e.message}`,{stack:e.stack});const s=new o(500,"SERVER_ERROR","Login Gagal.","Terjadi kesalahan di server. Silakan coba lagi nanti.");t.status(500).json(s.toResponse())}},t.deleteDocuments=async(e,t)=>{try{let s=l(e?.body?.document_ids);if(0===s.length&&(s=l(e?.query?.ids)),0===s.length){const e=new o(400,"INVALID_INPUT","Gagal Menghapus Dokumen","Mohon kirimkan document_ids yang valid.");return t.status(400).json(e.toResponse())}const n=/^[0-9a-f]{8}-[0-9a-f]{4}-4[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i,r=s.filter(e=>!n.test(e));if(r.length){const e=new o(400,"INVALID_INPUT","Gagal Menghapus Dokumen",`Terdapat ID tidak valid: ${r.join(", ")}`);return t.status(400).json(e.toResponse())}const u=await a(s);if(Array.isArray(u)&&u.length>0)for(const e of u)i.info(`| Delete Documents Server | - Dokumen id ${e} berhasil dihapus.`);const c=s.filter(e=>!u.includes(e));if(c.length>0&&i.warn(`| Delete Documents Server | - ID tidak ditemukan/gagal dihapus: ${c.join(", ")}`),!u||0===u.length){const e=new o(404,"NO_DOCUMENT_DELETED","Dokumen Tidak Ditemukan","Tidak ada dokumen yang berhasil dihapus.");return t.status(404).json(e.toResponse())}const d=new o(200,"DELETE_SUCCESS","Dokumen Berhasil Dihapus",`Berhasil menghapus ${u.length} dokumen.`);return t.status(200).json(d.toResponse())}catch(e){i.error(`| Delete Documents Server | - Server error: ${e.message}`,{stack:e.stack});const s=new o(500,"SERVER_ERROR","Gagal Menghapus Dokumen","Terjadi kesalahan di server. Silakan coba lagi nanti.");return t.status(500).json(s.toResponse())}}},456:(e,t,s)=>{const{URL:a}=s(16);function n(e){const t=(process.env[e]??"").toString().trim();if(!t)throw new Error(`ENV wajib "${e}" belum diisi.`);return t}e.exports={isLinux:function(){return"linux"===n("PG_ENV").toLowerCase()},resolvePublicBaseUrl:function(){return function(e){let t;try{t=new a(e)}catch{throw new Error('ENV "DOC_SERVER_BASE_URL" harus URL valid (contoh: http://localhost:1234).')}const s=(t.pathname||"/").replace(/\/+$/,""),n=s&&"/"!==s?s:"";return`${t.protocol}//${t.host}${n}`}(n("DOC_SERVER_BASE_URL"))},getRequiredIntEnv:function(e){const t=n(e),s=Number(t);if(!Number.isInteger(s))throw new Error(`ENV "${e}" harus integer. Dapat: "${t}"`);return s}}},461:e=>{"use strict";e.exports=require("multer")},484:(e,t,s)=>{const a=s(124),n=a.createLogger({level:"info",format:a.format.combine(a.format.timestamp(),a.format.json()),transports:[new a.transports.Console({format:a.format.combine(a.format.colorize({all:!0}),a.format.simple())}),new a.transports.File({filename:"logger.log"})]});e.exports=n},501:(e,t,s)=>{const{body:a}=s(975);t.loginValidator=[a("email").notEmpty().withMessage("Email tidak boleh kosong.").bail().isEmail().withMessage("Silahkan masukkan email yang valid, bisa berupa @gmail atau yang lain."),a("password").notEmpty().withMessage("Password tidak boleh kosong.").bail().isLength({min:8}).withMessage("Password minimal terdiri dari 8 karakter.")]},525:e=>{"use strict";e.exports=require("helmet")},577:e=>{"use strict";e.exports=require("cors")},623:(e,t,s)=>{const a=s(835).createClient({socket:{host:"localhost",port:6379}});(async()=>{try{await a.connect(),console.log("✅ Redis client connected successfully.")}catch(e){console.error("❌ Redis connection error:",e)}})(),a.on("error",e=>{console.error("Redis Error:",e)}),e.exports=a},636:(e,t,s)=>{const a=s(252).Router(),n=s(341),r=s(97),o=s(22),i=s(967);a.post("/upload-file",i,o,r.array("files",20),n.uploadDocuments),a.delete("/delete-file",i,o,n.deleteDocuments),e.exports=a},654:(e,t,s)=>{const a=s(729),n=s(829),{blacklistToken:r}=s(284),{validationResult:o}=s(975),i=s(484),l=s(930),u=s(332),c=s(870),d=process.env.JWT_SECRET_KEY;t.login=async(e,t)=>{if(!o(e).isEmpty()){const e=new c(400,"VALIDATION_FAILED","Login Gagal.","Tolong periksa kembali input anda. Pastikan email dan password terisi dengan benar.");return t.status(400).json(e.toResponse())}const{email:s,password:r}=e.body;try{const e=await l("users").where({email:s}).first();if(!e){i.info(`| Login | - Invalid credentials for email: ${s}, at ${(new Date).toISOString()}`);const e=new c(400,"INVALID_CREDENTIALS","Login Gagal.","Password atau email yang anda masukkan tidak valid, silahkan periksa kembali dan pastikan akun anda sudah terdaftar.");return t.status(400).json(e.toResponse())}if(!await a.compare(r,e.password)){i.info(`| Login | - Invalid credentials for email: ${s}, at ${(new Date).toISOString()}`);const e=new c(400,"INVALID_CREDENTIALS","Login Gagal.","Password atau email yang anda masukkan tidak valid, silahkan periksa kembali dan pastikan akun anda sudah terdaftar.");return t.status(400).json(e.toResponse())}await l("users").where({id:e.id}).update({last_login:l.fn.now()});const o={userId:e.id},m=n.sign(o,d);i.info(`| Login | - Login success for email: ${s}, at ${(new Date).toISOString()}`);const p={id:e.id,name:e.name,email:e.email,username:e.username,last_login:e.last_login},g=new u(200,"LOGIN_SUCCESS","Login Berhasil.","Selamat datang, anda berhasil login di server Rimba Dokumen.",{token:m,user:p});t.status(200).json(g.toResponse())}catch(e){i.error(`| Auth | - Error function login: ${e.message}`);const s=new c(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silahkan coba lagi nanti atau hubungi admin.");t.status(500).json(s.toResponse())}},t.logout=async(e,t)=>{const s=e.userId,a=e.header("Authorization")?.replace("Bearer ","");try{if(!s){const e=new c(401,"NO_ACTIVE_SESSION","Logout Gagal","Anda tidak memiliki sesi login yang aktif.");return i.info(`| Logout | - No active session for userId: ${s}`),t.status(401).json(e.toResponse())}const e=n.decode(a).exp-Math.floor(Date.now()/1e3);await r(a,e),i.info(`| Logout | - Logout success for userId: ${s}, at ${(new Date).toISOString()}`);const o=new c(200,"LOGOUT_SUCCESS","Logout Berhasil","Anda berhasil melakukan logout.");t.status(200).json(o.toResponse())}catch(e){i.error(`| Auth | - Error function logout: ${e.message}`);const s=new c(500,"SERVER_ERROR","Server Sedang Error","Terjadi kesalahan pada sistem, silahkan coba lagi nanti atau hubungi admin.");t.status(500).json(s.toResponse())}}},701:(e,t,s)=>{const a=s(896),n=s(928),r=s(930),o=s(484),{resolvePublicBaseUrl:i}=s(456);function l(e){if(!e||0===e)return"0 b";const t=Math.floor(Math.log(e)/Math.log(1024));return`${(e/Math.pow(1024,t)).toFixed(2)} ${["b","kB","mB","gB","tB"][t]}`}function u(e,t){return`${String(e||"").replace(/\/+$/,"")}/${String(t||"").replace(/^\/+/,"")}`}function c(e,t){const s=n.basename(t||"file"),r=n.extname(s),o=n.basename(s,r);let i=n.join(e,s),l=1;for(;a.existsSync(i);)i=n.join(e,`${o}(${l})${r}`),l+=1;return i}e.exports={uploadDocuments:async function(e){const t=[],s=Array.isArray(e)?e:[],d=n.join(__dirname,"../public/storage/documents");try{m=d,a.existsSync(m)||a.mkdirSync(m,{recursive:!0}),o.info(`| Upload Documents Server Helper | - Folder siap: ${d}`)}catch(e){throw o.error(`| Upload Documents Server Helper | - Gagal menyiapkan folder: ${e.message}`),new Error("Gagal menyiapkan direktori penyimpanan dokumen.")}var m;const p=i();for(const e of s)try{const s=c(d,n.basename(e.originalname||"file"));a.renameSync(e.path,s);const i=`storage/documents/${n.basename(s)}`,m=u(p,i),g=e.mimetype,k=Number(e.size)||0,h=l(k),f=await r("documents").insert({file_name:n.basename(s),file_path:i,file_url:m,file_mime_type:g,file_size:k}).returning(["id","created_at","updated_at"]),S=f?.[0];t.push({server_file_id:String(S.id),server_file_name:n.basename(s),server_file_path:i,server_file_url:m,server_file_mime_type:g,server_file_size:h}),o.info(`| Upload Documents Server Helper | - Success: ${n.basename(s)} (${h})`)}catch(t){o.error(`| Upload Documents Server Helper | - Failed on file ${e?.originalname}: ${t.message}`)}return t},deleteDocuments:async function(e=[]){const t=[],s=Array.isArray(e)?e:[];for(const e of s)try{const s=await r("documents").select("file_path").where({id:e}).first();if(!s){o.warn(`| Delete Documents Server Helper | - Dokumen ID ${e} tidak ditemukan.`);continue}const i=n.join(__dirname,"../public",s.file_path);a.existsSync(i)?a.unlinkSync(i):o.warn(`| Delete Documents Server Helper | - File tidak ditemukan: ${i}`),await r("documents").where({id:e}).del(),t.push(String(e)),o.info(`| Delete Documents Server Helper | - Dokumen ${e} berhasil dihapus.`)}catch(t){o.error(`| Delete Documents Server Helper | - Gagal menghapus dokumen ${e}: ${t.message}`)}return t}}},729:e=>{"use strict";e.exports=require("bcryptjs")},763:e=>{"use strict";e.exports=require("express-rate-limit")},818:e=>{"use strict";e.exports=require("dotenv")},829:e=>{"use strict";e.exports=require("jsonwebtoken")},832:e=>{"use strict";e.exports=require("knex")},835:e=>{"use strict";e.exports=require("redis")},870:e=>{e.exports=class{constructor(e,t=null,s,a){this.status=e,this.case=t,this.title=s,this.description=a}toResponse(){return{status:this.status,case:this.case,message:{title:this.title,description:this.description}}}}},896:e=>{"use strict";e.exports=require("fs")},928:e=>{"use strict";e.exports=require("path")},930:(e,t,s)=>{function a(e){const t=(process.env[e]??"").toString().trim();if(!t)throw new Error(`ENV wajib "${e}" belum diisi.`);return t}function n(e){const t=a(e),s=Number(t);if(!Number.isInteger(s))throw new Error(`ENV "${e}" harus integer. Dapat: "${t}"`);return s}const r=s(832)({client:"pg",connection:function(){const e=a("PG_ENV").toLowerCase().toUpperCase();return{host:a(`DB_HOST_${e}`),port:n(`DB_PORT_${e}`),user:a(`DB_USER_${e}`),password:a(`DB_PASSWORD_${e}`),database:a(`DB_NAME_${e}`)}}(),pool:{min:2,max:50},acquireConnectionTimeout:1e4});e.exports=r},967:(e,t,s)=>{const{rateLimit:a,ipKeyGenerator:n}=s(763),r=s(870),o=s(484),i=a({windowMs:6e4,max:20,keyGenerator:n,standardHeaders:!0,legacyHeaders:!1,message:()=>new r(429,"TOO_MANY_REQUESTS","Terlalu Banyak Permintaan","Anda terlalu banyak melakukan permintaan, coba lagi setelah beberapa saat.").toResponse(),handler:(e,t)=>{const s=new r(429,"TOO_MANY_REQUESTS","Terlalu Banyak Permintaan","Anda terlalu banyak melakukan permintaan, coba lagi setelah beberapa saat.");o.warn(`| RateLimiter | Too many requests from IP: ${e.ip}`),t.status(429).json(s.toResponse())}});e.exports=i},975:e=>{"use strict";e.exports=require("express-validator")}},t={};function s(a){var n=t[a];if(void 0!==n)return n.exports;var r=t[a]={exports:{}};return e[a](r,r.exports,s),r.exports}s(818).config();const a=s(525),n=s(252),r=s(96),o=s(87),i=(s(484),s(928)),l=s(636),u=s(82),{isLinux:c,resolvePublicBaseUrl:d}=s(456),m=n();m.use(a()),c()&&m.set("trust proxy",1);const p=Number(process.env.DOC_SERVER_PORT);m.locals.baseUrl=d(),m.use(u),m.use(n.json()),m.use(r("dev")),m.get("/cms",(e,t)=>{t.json({message:"Welcome to the Rimba Document!"})}),m.get("/cms/debug/urls",(e,t)=>{t.json({PG_ENV:process.env.PG_ENV,PORT:p,baseUrl:m.locals.baseUrl})}),m.use("/cms/api/rimba/docs",o),m.use("/cms/storage",n.static(i.join(__dirname,"../public/storage"))),m.use("/cms/api/rimba/docs",l),m.listen(p,()=>console.log(`Server running on port ${p}`))})();